
## 什么是索引
索引的目的是在于提高查询效率，本质是一种数据结构

## 索引原理
通过不断的缩小想要获得数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是我们总是通过同一种查找方式来锁定数据。

## 索引的存储分类
索引是在MYSQL的存储引擎层中实现的，而不是在服务层实现的。所以每种存储引擎的索引都不一定完全相同，也不是所有的存储引擎都支持所有的索引类型。MYSQL目前提供了一下4种索引。
* B-Tree 索引：最常见的索引类型，大部分引擎都支持B树索引。
* HASH 索引：只有Memory引擎支持，使用场景简单。
* R-Tree 索引(空间索引)：空间索引是MyISAM的一种特殊索引类型，主要用于地理空间数据类型。
* Full-text (全文索引)：全文索引也是MyISAM的一种特殊索引类型，主要用于全文索引，InnoDB从MYSQL5.6版本提供对全文索引的支持。

## 索引的数据结构
```
b+树

m= 磁盘块的大小/数据项的大小

h=㏒(m+1)N   (h:树的高度 m:每个磁盘块的数据项的数据量 N:当前数据表的数据)

树的高度代表IO发生的次数 因此当N一定时，索引字段越小，树的高度就越小，发生IO次数越少


当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，
比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，果name相同再依次比较age和sex，最后得到检索的数据；
但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。
比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。
```

## B-Tree索引类型
* 普通索引
* UNIQUE索引(字段唯一 为null时允许有多个)
* PRIMARY KRY索引(字段唯一 不能为null)

## 建立索引的原则
* 最左前缀匹配原则 非常重要的原则，mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，比如a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。

* =和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式

* 尽量选择区分度高的列作为索引,区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录

* 索引列不能参与计算，保持列“干净”，比如from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’);

* 尽量的扩展索引，不要新建索引。比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可

* 更新频繁的字段不适合做索引(同一时间段内更新的次数大于使用该字段作为条件进行查询的次数)

* 索引的选择主要考虑在where子句出现的列 在join字句出现的列, 而不是在SELECT关键字后选选择列表的列

* 使用短索引, 如果对字符串进行索引 应该指定一个前缀长度 节省索引空间 提升查询速度

## 优化工具
* 美团开源工具 SQLAdviso

## 索引的注意事项
虽然索引可以加快查询速度,但是索引的本身需要存储空间,加重插入、删除和修改记录时的负担, 另外mysql在运行时也需要消耗资源维护索引
* 表中数据少时(大约1000-2000)条,没必要创建索引

* Index Selectivity = Cardinality / #T  Cardinality不重复的索引值 #T表记录数

* MySQL只对一下操作符才使用索引：<,<=,=,>,>=,between,in, 以及某些时候的like(不以通配符%或_开头的情形)

* 不要过度索引，只保持所需的索引。每个额外的索引都要占用额外的磁盘空间，并降低写操作的性能。 在修改表的内容时，索引必须进行更新，有时可能需要重构，因此，索引越多，所花的时间越长
